<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TTS メモ読み上げ</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; margin: 16px; }
    textarea { width: 100%; height: 40vh; font-size: 16px; padding: 12px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }
    button, select, input[type="range"] { font-size: 16px; }
    button { padding: 10px 12px; }
    label { display: flex; align-items: center; gap: 8px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; }
    small { color: #666; }
  </style>
</head>
<body>
  <h2>テキスト→スピーチ（簡易）</h2>

  <textarea id="text" placeholder="ここにテキストを貼り付けて再生"></textarea>

  <div class="row">
    <button id="play">▶︎ 再生</button>
    <button id="pause">⏸ 一時停止</button>
    <button id="resume">⏯ 再開</button>
    <button id="stop">⏹ 停止</button>
  </div>

  <div class="card">
    <div class="row">
      <label>声:
        <select id="voice"></select>
      </label>
    </div>

    <div class="row">
      <label>速度 <input id="rate" type="range" min="0.5" max="2" step="0.1" value="1" /></label>
      <span id="rateVal">1.0</span>
    </div>

    <div class="row">
      <label>高さ <input id="pitch" type="range" min="0" max="2" step="0.1" value="1" /></label>
      <span id="pitchVal">1.0</span>
    </div>

    <div class="row">
      <label>音量 <input id="volume" type="range" min="0" max="1" step="0.1" value="1" /></label>
      <span id="volumeVal">1.0</span>
    </div>

    <small>※端末・ブラウザによって利用できる声が違います（iPhoneは選択肢が少なめになりがち）</small>
  </div>

<script>
  const t = document.getElementById('text');
  const voiceSel = document.getElementById('voice');
  const rate = document.getElementById('rate');
  const pitch = document.getElementById('pitch');
  const volume = document.getElementById('volume');
  const rateVal = document.getElementById('rateVal');
  const pitchVal = document.getElementById('pitchVal');
  const volumeVal = document.getElementById('volumeVal');

  // 保存/復元
  const KEY = 'simple_tts_state_v1';
  const load = () => {
    try {
      const s = JSON.parse(localStorage.getItem(KEY) || '{}');
      if (s.text) t.value = s.text;
      if (s.rate) rate.value = s.rate;
      if (s.pitch) pitch.value = s.pitch;
      if (s.volume) volume.value = s.volume;
    } catch {}
    syncLabels();
  };
  const save = () => {
    localStorage.setItem(KEY, JSON.stringify({
      text: t.value,
      rate: rate.value,
      pitch: pitch.value,
      volume: volume.value,
      voiceURI: voiceSel.value
    }));
  };

  function syncLabels(){
    rateVal.textContent = Number(rate.value).toFixed(1);
    pitchVal.textContent = Number(pitch.value).toFixed(1);
    volumeVal.textContent = Number(volume.value).toFixed(1);
  }

  let voices = [];
  function populateVoices(){
    voices = speechSynthesis.getVoices();
    voiceSel.innerHTML = '';
    const saved = (() => { try { return JSON.parse(localStorage.getItem(KEY)||'{}'); } catch { return {}; } })();

    voices.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v.voiceURI;
      opt.textContent = `${v.name} (${v.lang})`;
      voiceSel.appendChild(opt);
    });

    // 保存したvoiceURIがあれば優先
    if (saved.voiceURI && voices.some(v => v.voiceURI === saved.voiceURI)) {
      voiceSel.value = saved.voiceURI;
    } else {
      // 日本語っぽいのがあれば選ぶ
      const ja = voices.find(v => v.lang && v.lang.toLowerCase().startsWith('ja'));
      if (ja) voiceSel.value = ja.voiceURI;
    }
  }

  // iOS/SafariはgetVoicesが遅延することがあるのでイベントも使う
  speechSynthesis.onvoiceschanged = populateVoices;

  function buildUtterance(text){
    const u = new SpeechSynthesisUtterance(text);
    const v = voices.find(v => v.voiceURI === voiceSel.value);
    if (v) u.voice = v;
    u.rate = Number(rate.value);
    u.pitch = Number(pitch.value);
    u.volume = Number(volume.value);
    return u;
  }

  function speak(){
    const text = t.value.trim();
    if (!text) return;

    // 既存キューを消してから
    speechSynthesis.cancel();

    // 長文対策：ざっくり分割（句点/改行）
    const parts = text
      .split(/(?<=[。．.\n])\s*/g)
      .map(s => s.trim())
      .filter(Boolean);

    // 連結再生
    parts.forEach((p, i) => {
      const u = buildUtterance(p);
      // 最後だけ保存
      if (i === parts.length - 1) u.onend = save;
      speechSynthesis.speak(u);
    });

    save();
  }

  document.getElementById('play').onclick = speak;
  document.getElementById('pause').onclick = () => speechSynthesis.pause();
  document.getElementById('resume').onclick = () => speechSynthesis.resume();
  document.getElementById('stop').onclick = () => speechSynthesis.cancel();

  [t, voiceSel, rate, pitch, volume].forEach(el => el.addEventListener('input', () => { syncLabels(); save(); }));

  load();
  populateVoices();
</script>
</body>
</html>
